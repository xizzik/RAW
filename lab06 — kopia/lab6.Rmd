---
title: "Regresja i analiza wariancji - Laboratorium 6"
subtitle: 'Jednoczynnikowa analiza wariancji - ciąg dalszy' 
author: 
  name: 'Adrian Kowalski'
  affiliation: 'Politechnika Krakowska'
output:
  html_document:
    theme: readable
    df_print: paged
    toc: true
    toc_float: true
---

# Analiza mocy

Podstawą frekwentystycznego podejścia do testowania hipotez jest analiza mocy apriori (czyli przed wykonaniem testu), w celu wyznaczenia odpowiedniej jaką ilość obserwacji należy zebrać, aby uzyskać odpowiednią moc testu. Równania mocy są na ogół bardzo trudne do rozwiązania i wykorzystuje się jedynie numeryczne przybliżenia. W celu wyznaczenia rozmiaru próby z równania mocy bardzo często potrzebne są również oszacowane wartości parametrów populacji, które trudno jest przecież znać. 

# Zadanie


W pliku danec2a.xlsx znajdują się dane biometryczne drzewek z 7-letniej
plantacji sosnowej założonej z sadzonek wyprodukowanych z odkrytym systemem
korzeniowym (System - Odkryty), sadzonek wyprodukowanych w szkółce
kontenerowej z zakrytym systemem korzeniowym bez mikoryzacji (System - Con)
oraz mikoryzowanych grzybami Hebeloma (System - Heb) i Lacaria (System - Lac).
Zbadaj czy system produkcji sadzonek wpływa na wysokość (H) i grubość (D0) 7-
letnich sosen.


```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(tidyverse)
```
```{r, message=FALSE, warning=FALSE}
data1 <- readr::read_csv('danec2a.csv')
summary(data1)
```

# Analiza mocy - ciąg dalszy

Przeprowadzimy analizę mocy dla eksperymentu powyżej korzystając z danych w pliku. W celu rozwiązania równania mocy dla jednoczynnikowej, standardowej, analizy wariancji potrzebne nam są

- wariancja wewnątrz grup,
- wariancja pomiędzy grupami,
- oczekiwana moc,
- oczekiwany poziom istotności.

Do rozwiązania równania mocy służ funkcja *power.anova.test*. Atrybut tej funkcji, który zostanie pozostawiony przez nas jako **NULL** zostanie wyliczony z równania mocy.

Wyliczamy wariancję wewnątrz grup, jako średnią arytmetyczną oszacowanej wariancji z każdej grupy (ponieważ zakładamy, że wariancje są równe).
```{r}
no_groups <- length(unique(data1$System))
within_var_est <- data1 %>% group_by(System) %>% summarise(var = var(H)) %>% summarise(sum = sum(var)/no_groups) %>% pull(sum)
within_var_est
```
Wyliczamy wariancję między grupami (jest to zatem wariancja wektora ze średnimi wewnątrz grup).
```{r}
between_var_est <- data1 %>% group_by(System) %>% summarise(mean=mean(H)) %>% summarise(var = var(mean)) %>% pull(var)
between_var_est
```
Jesteśmy zatem gotowi do wyliczenia rozmiaru próby dla zbalansowanego projektu eksperymentu.

```{r}
power_analysis <- power.anova.test(groups=no_groups, n = NULL, 
                                   between.var = between_var_est,
                                   within.var = within_var_est,
                                   sig.level = 0.05,
                                   power = 0.8)
power_analysis
```
Czy powyższy eksperyment był zaprojektowany tak, aby osiągnął moc $0.8$?



# Test Bartletta i Levene

Ważnym założeniem klasycznej analizy wariancji jest stała wariancja w każdej z grup. To założenie możemy przetestować za pomocą testu Bartletta. Hipotezą zerową testu Bartletta jest $H_0: \sigma^2_1 = \sigma^2_2 = \dots = \sigma^2_k$, że w każdej z $k$ grup wariancja jest równa. Hipotezą alternatywną jest, że conajmniej jedna z wariancji różni się od pozostałych. Statystyka testowa testu Bartleta ma rozkład zwany rozkładem $K^2$, który można przybliżać za pomocą rozkładu $\chi^2$ o $k-1$ stopniach swobody. Ważnym założeniem przy wyprowadzaniu tego rozkładu jest fakt, że nasze populacje pochodzą z rozkładu normalnego.

```{r}
bartlett.test(H ~ System, data = data1)
```
W przypadku, gdy spotykamy się z populacjami, które nie mają rozkładu normalnego mamy alternatywny test do testu Bartletta - test Levene'a. Hipotezą zerowa i alternatywna testu jest identyczna jak w teście Bartletta. Jest on bardzo mocno powiązany z analizą wariancji, a jego statystyka testowa ma rozkład (w przybliżeniu) $F$ o $k-1$ i $n-k$ stopniach swobody.
```{r, message=FALSE, warning=FALSE}
library(car)
leveneTest(H ~ System, data = data1)
```


# Poprawka Welscha dla Analizy Wariancji

W praktyce założenie o równej wariancji między grupami może nie być zawsze spełnione. Na szczęście mamy narzędzie służące do przeprowadzenia analizy wariancji w tej sytuacji. Jest to tzw. Analiza Wariancji Welscha, lub z poprawką Welscha (podobnie jak przy teście $t$). 

```{r}
oneway.test(H ~ System, data = data1)
```
Nie możemy też użyć procedury Tukeya do analizy post-hoc, ale na szczęście tutaj również mamy alternatywę nie zakładającą stałej wariancji. Jest to test Gamesa-Howella, który znajdziemy w pakiecie *rstatix*.
```{r, message=FALSE, warning=FALSE, echo=FALSE}
library(rstatix)
```
```{r}
ghTest1 <- rstatix::games_howell_test(H ~ System, data = data1)
ghTest1 <- ghTest1 %>% dplyr::mutate(gr_label = paste(group1,group2, sep='-')) %>% dplyr::mutate(order = row_number())
ghTest1
```

```{r}
ggplot(ghTest1, aes(x=estimate, y = order)) +  geom_linerange(aes(xmin = conf.low, xmax = conf.high)) + geom_point() + scale_y_discrete(name = '', limits = as.factor(ghTest1$order), labels = ghTest1$gr_label) + geom_vline(xintercept = 0, color = 'red', linetype = 'dashed')
```
# Alternatywa nieparametryczna - test Kruskalla-Wallisa

Nieparametryczną alternatywą jednoczynnikowej analizy wariancji jest test Kruskala-Wallisa. Nie wymaga on już założenia o normalności rozkładów testowanych populacji, ani założenia o stałej wariancji pomiędzy grupami. Działa on na bazie median, jest to przykład tzw. testu na rangach. Hipoteza zerowa tego testu sprowadza się do odpowiedzi na pytanie czy dane pochodzą z tego samego rozkładu (formalnie - mediana każdej z grup jest sobie równa). Rozkład statystyki $H$ przybliża się za pomocą rozkładu $\chi^2$.

```{r}
kruskal.test(H ~ System, data = data1)
```
Do analizy post-hoc w tym wypadku używamy tzw. testu Dunna.

```{r, message=FALSE, warning=FALSE}
library(FSA)
FSA::dunnTest(H ~ System, data = data1)
```
# Uwaga: Poprawka Bonferroniego

W wielu przypadkach powyżej zaobserwowaliśmy tzw. $p$-adjusted, czyli poprawioną $p$-wartość. Jest to związane z faktem, że gdy wykonujemy testy, których wyniki zależą od siebie, tak jak procedura Tukeya lub test Dunna, to prawdopodobieństwo popełnienia błędu pierwszego rodzaju z tych testów kumuluje się. Walczymy z tym za pomocą poprawki Bonferoniego. Jeżeli $m$ to ilość zparowanych w takim sensie jak powyżej testów, które wykonujemy to, aby skożystać z poprawki Bonferroniego ustalamy nasz poziom istotności $\overline{alpha} = \frac{\alpha}{m}$ lub mnożymy $p_{adj} = m*p$. Nie jest to jedyna poprawka $p$-wartości jaką możemy stosować, ale jest ona dość prosta w wyprowadzeniu. Faktycznie, niech $FWER$ oznacza poziom błędu w całej rodzinie testów przez nas przeprowadzanych, $p_i$ będzie $p$-wartością $i$-tego testu, a $m_0$ niech będzie wartością prawdziwych hipotez zerowych (zauważmy, że nie znamy tej liczby). Wtedy \[ FWER = \mathbb{P} \left( \bigcup_{i=1}^{m_0}\left(p_i \leq \frac{\alpha}{m} \right) \right) \leq \sum_{i=1}^{m_0} \mathbb{P} \left(  p_i \leq \frac{\alpha}{m}\right) = m_0 \frac{\alpha}{m} \leq \alpha.\]

# Ćwiczenie 1


Zbadaj czy system produkcji sadzonek wykorzystanych do założenia plantacji ma
wpływ na wielkość nadziemnej biomasy 7-letnich sosen?

```{r}
danec2a <- readr::read_csv('danec2a.csv')
head(danec2a)
```
```{r}
unique(danec2a$System)
```

# Ćwiczenie 2

Korzystając z danych zawartych w pliku danec3.xlsx zbadaj, czy wiek ma
wpływ na długość czaszki saren. Analizy przeprowadź oddzielnie dla poszczególnych
rodzajów obwodów łowieckich.

Zbadaj wpływ wieku na szerokość czaszki saren (analizy oddzielnie dla rodzajów
obwodów).

Zbadaj czy rodzaj obwodu ma istotny wpływ na masę poroża saren (analizy oddzielne
dla klas wieku).

```{r}
danec2 <- readr::read_csv('danec2.csv')
head(danec2)
```

# Ćwiczenie 3

Korzystając z danych zawartych w pliku DL_dane_cw2.xlsx sprawdź czy
analizowane drzewostany różnią się istotnie pod względem długości koron (LK).

Sprawdź czy analizowane drzewostany różnią się pod względem względnej długości
koron (LKw).

Porównaj średnie wysokości drzew w analizowanych drzewostanach.

Zbadaj czy system produkcji sadzonek
wpływa na biomasę korzeni oraz biomasę igieł 7-letnich sosen?


```{r}
danec3 <- readr::read_csv('danec3.csv')
head(danec3)
```